<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.1.1/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <title>Vue 3</title>
</head>
<body>
  <div id="app"></div>
  <script src="https://unpkg.com/vue@next"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.1.1/dist/vuetify.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet-src.js"></script>
  <script src="./vue-leaflet.umd.js"></script>
  <script>
// Vue3 Composition API
const { createApp, ref, onMounted } = Vue
const { createVuetify } = Vuetify
const { LMap, LTileLayer, LMarker, LPopup } = VueLeaflet
const vuetify = createVuetify()

const app = createApp({
  template: `<main-page />`
}).use(vuetify)
  
app.component('main-page', {
  components: {
    LMap,
    LTileLayer,
    LMarker,
    LPopup
  },
  setup() {
    const map = ref()
    const { data, loading } = useGetCsv(url, encoding)

    const items = computed(() => {
      const _items = []
      for (const row of data.value) {
        if (!('緯度' in row) || !('経度' in row)) continue
          _items.push({
            ...row,
            lat: +row['緯度'],
            long: +row['経度']
          })
      }
      return _items
    })

    const bounds = computed(() => {
      let _bounds
      for (const {lat, long} of items.value) {
        if (!_bounds) _bounds = [[lat, long],[lat, long]];
        if (_bounds[1][0] > lat) _bounds[1][0] = lat
        if (_bounds[0][0] < lat) _bounds[0][0] = lat
        if (_bounds[1][1] > long) _bounds[1][1] = long
        if (_bounds[0][1] < long) _bounds[0][1] = long
      }
      return _bounds
    })

    const onReady = () => {
      map.value.leafletObject.fitBounds(bounds.value)
    }

    return { items, bounds, map, onReady }
  },
  template: `
    <l-map ref="map" :bounds="bounds" @ready="onReady" style="position: absolute; top: 0;right: 0; bottom: 0; left: 0;">
      <l-tile-layer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"></l-tile-layer>
      <l-marker v-for="item in items" 
        :lat-lng="{lat: item.lat, lon: item.long }" >
        <l-popup>
          {{ item['施設名'] }}
        </l-popup>
      </l-marker>
    </l-map>
  `
})

app.mount("#app")

  </script>
</body>
</html>